<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaiChart 乐曲导入助手</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- JSZip 用于解压检测 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 图标库 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-2xl">
        <!-- 主卡片 -->
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden border border-slate-200">
            <!-- 头部 -->
            <div class="bg-indigo-600 p-6 text-white relative overflow-hidden">
                <div class="relative z-10">
                    <h1 class="text-2xl font-bold flex items-center gap-3">
                        <i class="fa-solid fa-music"></i> 自制谱导入系统
                    </h1>
                    <p class="text-indigo-100 mt-2 text-sm">
                        自动检测自制谱并上传至法师窝
                    </p>
                </div>
                <!-- 装饰背景 -->
                <i class="fa-solid fa-compact-disc absolute -bottom-8 -right-8 text-9xl text-indigo-500 opacity-30 rotate-12"></i>
            </div>

            <div class="p-8">
                <!-- 步骤指示器 -->
                <div class="flex items-center justify-between mb-8 text-sm font-medium text-slate-400">
                    <div :class="{'text-indigo-600 font-bold': step >= 1}">1. 选择文件</div>
                    <div class="h-px bg-slate-200 flex-1 mx-4 transition-colors duration-300" :class="{'bg-indigo-200': step >= 2}"></div>
                    <div :class="{'text-indigo-600 font-bold': step >= 2}">2. 结构校验</div>
                    <div class="h-px bg-slate-200 flex-1 mx-4 transition-colors duration-300" :class="{'bg-indigo-200': step >= 3}"></div>
                    <div :class="{'text-indigo-600 font-bold': step >= 3}">3. 上传导入</div>
                </div>

                <!-- 1. 上传区域 -->
                <div v-if="step === 1" 
                     class="border-2 border-dashed rounded-xl p-12 text-center transition-all duration-300 relative group cursor-pointer"
                     :class="dragActive ? 'border-indigo-500 bg-indigo-50 scale-[1.02]' : 'border-slate-300 hover:border-indigo-400 hover:bg-slate-50'"
                     @dragenter.prevent="dragActive = true"
                     @dragleave.prevent="dragActive = false"
                     @dragover.prevent
                     @drop.prevent="handleDrop"
                     @click="$refs.fileInput.click()">
                    
                    <input type="file" ref="fileInput" @change="handleFileSelect" accept=".zip" class="hidden">
                    
                    <div class="pointer-events-none">
                        <div class="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6 transition-transform group-hover:scale-110 duration-300">
                            <i class="fa-solid fa-folder-open text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-slate-700">点击或拖拽 Zip 压缩包</h3>
                        <!-- <p class="text-slate-500 mt-2 text-sm">支持包含 maidata.txt 的标准乐曲包</p> -->
                    </div>
                </div>

                <!-- 2. 扫描与结果显示 -->
                <div v-if="step === 2" class="space-y-6">
                    <!-- 文件信息 -->
                    <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-lg border border-slate-200 shadow-sm">
                        <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center shrink-0">
                            <i class="fa-solid fa-file-zipper text-xl"></i>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <h4 class="font-bold text-slate-700 truncate">{{ file?.name }}</h4>
                            <p class="text-xs text-slate-500 mt-1">{{ formatSize(file?.size) }}</p>
                        </div>
                        <button @click="reset" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-100 text-slate-400 hover:text-red-500 transition-colors" title="移除文件">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <!-- 扫描中状态 -->
                    <div v-if="isScanning" class="text-center py-10">
                        <div class="inline-block relative">
                            <i class="fa-solid fa-circle-notch fa-spin text-5xl text-indigo-500"></i>
                            <i class="fa-solid fa-magnifying-glass absolute bottom-0 -right-2 text-2xl text-slate-600 bg-white rounded-full border-2 border-white"></i>
                        </div>
                        <p class="text-slate-600 mt-4 font-medium animate-pulse-slow">正在解压并校验文件结构...</p>
                    </div>

                    <!-- 扫描结果：失败 -->
                    <div v-else-if="scanResult && !scanResult.valid" class="bg-red-50 border border-red-200 rounded-xl p-6 shadow-sm">
                        <div class="flex items-start gap-4">
                            <div class="mt-1 bg-red-100 text-red-600 rounded-full w-8 h-8 flex items-center justify-center shrink-0">
                                <i class="fa-solid fa-triangle-exclamation"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-red-800 font-bold text-lg">文件校验未通过</h3>
                                <p class="text-red-700 text-sm mt-1">该压缩包不符合乐曲导入要求，请检查以下问题：</p>
                                
                                <!-- 错误详情列表 -->
                                <ul class="mt-4 space-y-2 bg-white/50 rounded-lg p-3">
                                    <li v-for="(error, idx) in scanResult.errors" :key="idx" class="text-sm text-red-600 flex items-center gap-2">
                                        <i class="fa-solid fa-circle-xmark text-xs"></i>
                                        {{ error }}
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <button @click="reset" class="mt-6 w-full py-2.5 bg-white border border-red-200 text-red-600 font-medium rounded-lg hover:bg-red-50 transition-colors shadow-sm">
                            重新选择文件
                        </button>
                    </div>

                    <!-- 扫描结果：成功 -->
                    <div v-else-if="scanResult && scanResult.valid" class="bg-green-50 border border-green-200 rounded-xl p-6 shadow-sm">
                        <div class="flex items-start gap-4">
                            <div class="mt-1 bg-green-100 text-green-600 rounded-full w-8 h-8 flex items-center justify-center shrink-0">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <div>
                                <h3 class="text-green-800 font-bold text-lg">校验通过</h3>
                                <p class="text-green-700 text-sm mt-1">压缩包结构完整，包含核心数据文件。</p>
                                <div class="mt-3 flex gap-2 flex-wrap">
                                    <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded border border-green-200 font-mono">
                                        <i class="fa-regular fa-file-lines mr-1"></i>maidata.txt
                                    </span>
                                    <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded border border-green-200 font-mono">
                                        {{ scanResult.fileCount }} 个文件
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button @click="reset" class="px-5 py-2.5 text-slate-500 hover:text-slate-700 font-medium transition-colors">取消</button>
                            <button @click="uploadFile" class="px-6 py-2.5 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 shadow-md hover:shadow-lg transition-all flex items-center gap-2 transform active:scale-95">
                                <i class="fa-solid fa-cloud-arrow-up"></i> 确认导入
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. 上传进度 -->
                <div v-if="step === 3" class="text-center py-8 space-y-6">
                    <!-- 上传中 -->
                    <div v-if="uploadStatus === 'uploading'">
                        <div class="w-24 h-24 mx-auto relative flex items-center justify-center">
                            <svg class="animate-spin h-full w-full text-indigo-200" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="absolute text-sm font-bold text-indigo-600">{{ uploadProgress }}%</span>
                        </div>
                        <div class="space-y-2">
                            <h3 class="text-lg font-medium text-slate-800">正在传输数据...</h3>
                            <p class="text-sm text-slate-500">正在请求 API: /import_music</p>
                        </div>
                    </div>

                    <!-- 成功 -->
                    <div v-else-if="uploadStatus === 'success'" class="animate-bounce-in">
                        <div class="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                            <i class="fa-solid fa-check text-4xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800">导入成功！</h3>
                        <div class="bg-slate-50 p-4 rounded-lg mt-4 text-left border border-slate-200">
                             <p class="text-sm text-slate-600 font-mono overflow-auto whitespace-pre-wrap">{{ apiResponse }}</p>
                        </div>
                        <button @click="reset" class="mt-8 px-8 py-2.5 bg-slate-800 text-white font-medium rounded-lg hover:bg-slate-700 shadow-lg hover:shadow-xl transition-all">
                            继续导入下一个
                        </button>
                    </div>

                    <!-- 失败 -->
                    <div v-else-if="uploadStatus === 'error'">
                        <div class="w-20 h-20 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                            <i class="fa-solid fa-triangle-exclamation text-4xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800">导入失败</h3>
                        <div class="bg-red-50 p-4 rounded-lg mt-4 text-left border border-red-100">
                            <p class="text-sm text-red-700 font-bold mb-1">服务端响应:</p>
                            <p class="text-xs text-red-600 font-mono break-all">{{ errorMessage }}</p>
                        </div>
                        <p class="text-slate-500 mt-2 text-sm">请确保后端服务 (Port 8000) 和 MCM Servlet (Port 5001) 均已启动。</p>
                        <button @click="step = 2" class="mt-8 px-6 py-2.5 bg-white border border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-slate-50 shadow-sm transition-colors">
                            返回重试
                        </button>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- 底部说明 -->
        <div class="mt-6 text-center">
            <!-- <p class="text-xs text-slate-400">
                Connected to: <span class="font-mono text-slate-500 bg-slate-200 px-1 rounded">127.0.0.1:8000</span>
            </p> -->
        </div>
    </div>

    <script>
        const { createApp, ref } = Vue;

        createApp({
            setup() {
                // 状态
                const step = ref(1);
                const file = ref(null);
                const dragActive = ref(false);
                const isScanning = ref(false);
                const scanResult = ref(null);
                const uploadStatus = ref('idle');
                const uploadProgress = ref(0);
                const apiResponse = ref('');
                const errorMessage = ref('');

                // 配置：API 端点 (指向本地 FastAPI)
                const API_ENDPOINT = 'http://127.0.0.1:8000/import_music'; 
                // 配置：禁止的文件
                const blacklistedExtensions = ['.exe', '.sh', '.bat', '.cmd', '.js', '.vbs', '.php', '.dll'];
                // 配置：必须包含的文件 (根据后端 logic)
                const requiredFiles = ['maidata.txt'];

                const formatSize = (bytes) => {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };

                const handleFileSelect = (e) => {
                    processFile(e.target.files[0]);
                };

                const handleDrop = (e) => {
                    dragActive.value = false;
                    processFile(e.dataTransfer.files[0]);
                };

                const processFile = (inputFile) => {
                    if (!inputFile) return;
                    if (!inputFile.name.toLowerCase().endsWith('.zip')) {
                        alert('仅支持 .zip 格式的压缩文件');
                        return;
                    }
                    file.value = inputFile;
                    step.value = 2;
                    scanZipContent(inputFile);
                };

                const scanZipContent = async (zipFile) => {
                    isScanning.value = true;
                    scanResult.value = null;

                    try {
                        const zip = new JSZip();
                        const content = await zip.loadAsync(zipFile);
                        
                        const invalidFiles = [];
                        const foundFiles = new Set();
                        let totalFiles = 0;

                        content.forEach((relativePath, zipEntry) => {
                            if (!zipEntry.dir) {
                                totalFiles++;
                                const fileName = zipEntry.name.toLowerCase();
                                const baseName = fileName.split('/').pop(); // 获取文件名，忽略路径

                                // 记录找到的文件名 (转小写)
                                foundFiles.add(baseName);
                                
                                // 检查黑名单
                                if (blacklistedExtensions.some(ext => fileName.endsWith(ext))) {
                                    invalidFiles.push(`检测到违规文件: ${zipEntry.name}`);
                                }
                            }
                        });

                        // 检查必需文件
                        const missingFiles = requiredFiles.filter(req => !foundFiles.has(req.toLowerCase()));
                        const errors = [...invalidFiles];
                        if (missingFiles.length > 0) {
                            errors.push(`缺失核心文件: ${missingFiles.join(', ')}`);
                        }

                        // 为了 UI 体验稍微延迟一下
                        setTimeout(() => {
                            isScanning.value = false;
                            scanResult.value = {
                                valid: errors.length === 0,
                                errors: errors,
                                fileCount: totalFiles
                            };
                        }, 600);

                    } catch (err) {
                        console.error(err);
                        isScanning.value = false;
                        scanResult.value = { valid: false, errors: ["ZIP 文件损坏或无法读取"] };
                    }
                };

                const uploadFile = () => {
                    if (!file.value) return;

                    step.value = 3;
                    uploadStatus.value = 'uploading';
                    uploadProgress.value = 0;
                    errorMessage.value = '';
                    apiResponse.value = '';

                    // 1. 进度条伪动画 (因为 fetch 默认不支持上传进度回调，除非用 XHR)
                    // 如果需要真实进度，需要用 axios 或 XMLHttpRequest
                    const progressInterval = setInterval(() => {
                        if (uploadProgress.value < 90) {
                            uploadProgress.value += Math.floor(Math.random() * 10);
                        }
                    }, 300);

                    // 2. 准备 FormData
                    const formData = new FormData();
                    // 注意：这里必须用 'music_file'，对应后端 fastapi 参数名
                    formData.append('music_file', file.value);

                    // 3. 发送请求
                    fetch(API_ENDPOINT, {
                        method: 'POST',
                        body: formData
                    })
                    .then(async response => {
                        clearInterval(progressInterval);
                        const data = await response.json();
                        
                        if (response.ok) {
                            uploadProgress.value = 100;
                            // 后端逻辑： status = await import_music(...)
                            // if status: return {"message": "乐曲导入成功"}
                            if (data.message && data.message.includes('成功')) {
                                uploadStatus.value = 'success';
                                apiResponse.value = data.message;
                            } else {
                                throw new Error(data.message || '后端处理返回失败');
                            }
                        } else {
                            throw new Error(data.detail || `HTTP Error: ${response.status}`);
                        }
                    })
                    .catch(error => {
                        clearInterval(progressInterval);
                        console.error('Upload error:', error);
                        uploadStatus.value = 'error';
                        errorMessage.value = error.message + " (请检查控制台 CORS 或网络连接)";
                    });
                };

                const reset = () => {
                    step.value = 1;
                    file.value = null;
                    scanResult.value = null;
                    uploadStatus.value = 'idle';
                    uploadProgress.value = 0;
                    errorMessage.value = '';
                };

                return {
                    step, file, dragActive, isScanning, scanResult,
                    uploadStatus, uploadProgress, apiResponse, errorMessage,
                    handleFileSelect, handleDrop, uploadFile, reset, formatSize
                };
            }
        }).mount('#app');
    </script>
</body>
</html>